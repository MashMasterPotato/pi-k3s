- name: Provision Raspberry Pi as single-node k3s
  hosts: pi
  become: true
  gather_facts: true

  handlers:
    - name: reboot pi
      reboot:
        reboot_timeout: 600

  tasks:
    - name: Wait for SSH
      wait_for_connection:
        timeout: 300

    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages for k3s on Raspberry Pi OS
      apt:
        name:
          - curl
          - ca-certificates
          - bash
          - iptables
          - iptables-persistent
        state: present

    - name: Install vim
      apt:
        name: vim
        state: present

    - name: Set vim as default editor for vi
      alternatives:
        name: vi
        path: /usr/bin/vim.basic

    # Enable cgroup memory support (needed on many Raspberry Pi OS installs)
    - name: Ensure cgroup memory flags are present in cmdline
      lineinfile:
        path: /boot/firmware/cmdline.txt
        backrefs: true
        regexp: '^(.*)$'
        line: '\1 cgroup_enable=memory cgroup_memory=1'
      notify: reboot pi

    # Optional: swap off (recommended for Kubernetes)
    - name: Disable swap immediately (recommended)
      command: swapoff -a
      changed_when: false
      failed_when: false

    - name: Comment out swap in /etc/fstab (recommended)
      replace:
        path: /etc/fstab
        regexp: '^(.*\sswap\s.*)$'
        replace: '# \1'
      failed_when: false

    # Install k3s using bash and skip SELinux RPM checks (not relevant on Pi OS)
    - name: Install k3s (single-node)
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_SELINUX_RPM=true bash -s - server \
          --write-kubeconfig-mode 644
      args:
        creates: /usr/local/bin/k3s

    - name: Ensure k3s is enabled and running
      systemd:
        name: k3s
        enabled: true
        state: started